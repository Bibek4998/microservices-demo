name: CI/CD â€“ Deploy Sock Shop to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper sync

      - name: Deploy via SSH to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # 1. Navigate to your project directory
            cd ~/microservices-demo/deploy/docker-compose

            # 2. Pull latest code from GitHub
            echo "Pulling latest code from GitHub..."
            git pull origin main

            # 3. Navigate to docker-compose directory
            cd deploy/docker-compose

            # 4. Pull latest Docker images
            echo "Pulling latest Docker images..."
            docker compose pull

            # 5. Stop and remove containers
            echo "Stopping existing containers..."
            docker compose down

            # 6. Start new containers
            echo "Starting new containers..."
            docker compose up -d --build  # Add --build if using Dockerfile

