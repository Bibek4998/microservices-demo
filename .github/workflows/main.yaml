name: CI â€” build images & deploy to kind (no registry)

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

env:
  KIND_CLUSTER_NAME: capstone
  KIND_NODE_IMAGE: kindest/node:v1.29.0
  K8S_NAMESPACE: sock-shop
  WAIT_TIMEOUT: 15m

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v2

      - name: Start KinD cluster
        uses: engineerd/setup-kind@v0.5.0
        with:
          version: v0.20.0
          image: ${{ env.KIND_NODE_IMAGE }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: '1.29.0'

      - name: Discover & build Dockerfile services, tag & load into kind
        id: build_and_load
        run: |
          set -euxo pipefail
          OWNER=${{ github.repository_owner }}
          SHA=${{ github.sha }}

          # find directories containing a Dockerfile (depth 2)
          mapfile -t services < <(find . -maxdepth 2 -type f -name Dockerfile -printf '%h\n' | sed 's|^\./||' | sort -u)

          if [ ${#services[@]} -eq 0 ]; then
            echo "no services found with Dockerfile"
            # export empty outputs for later steps
            echo "svc_to_img=" >> "$GITHUB_OUTPUT"
            echo "images=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "services found: ${services[*]}"
          rm -f /tmp/built-images.txt /tmp/svc-to-img.txt || true
          touch /tmp/built-images.txt /tmp/svc-to-img.txt

          for svc in "${services[@]}"; do
            svc_name="${svc//\//-}"          # sanitize folder path to token
            img="local/${OWNER}/${svc_name}:${SHA}"
            echo "building ${svc} -> ${img}"
            docker build -f "${svc}/Dockerfile" -t "${img}" "${svc}"
            echo "loading ${img} into kind"
            kind load docker-image "${img}" --name "${KIND_CLUSTER_NAME}"
            echo "${img}" >> /tmp/built-images.txt
            echo "${svc_name}:${img}" >> /tmp/svc-to-img.txt
          done